{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
    "parameters": {
      "Workbook 1": {
        "type": "string",
        "defaultValue": "Over Utilized VMs",
        "metadata": {
          "description": "Shows CPU , Memory and Disk Usage greater than 80% most of the time for all Azure and on-premises machines."
        }
      },
      "Workbook 2": {
        "type": "string",
        "defaultValue": "Under Utilized VMs",
        "metadata": {
          "description": "Shows CPU and  Memory Usage Less than 35% most of the time and Disk Usage less then 10% for all Azure and on-premises machines."
        }
      },
      "Workbook 3": {
        "type": "string",
        "defaultValue": "VM utilization over the time",
        "metadata": {
          "description": "Used to Check specifice VMs for CPU and Memory Utilization over the time."
        }
      },
      "Workbook 4": {
        "type": "string",
        "defaultValue": "VM Disk Usage",
        "metadata": {
          "description": "Show list of all Disks and their Usage for all Azure and on premise machines."
        }
      }
    },
    "resources": [
      {
        "name": "[guid(parameters('Workbook 1'))]",
        "type": "microsoft.insights/workbooks",
        "location": "[resourceGroup().location]",
        "apiVersion": "2022-04-01",
        "dependsOn": [],
        "kind": "shared",
        "properties": {
          "displayName": "[parameters('Workbook 1')]",
          "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Over Utilized VMs\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"value::all\"],\"parameters\":[{\"id\":\"96d624a1-a062-42af-a2f1-cb99e39ee61f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"value\":null,\"typeSettings\":{\"additionalResourceOptions\":[],\"includeAll\":true}},{\"id\":\"eed277a7-4cd8-4699-9aa8-72189163c7b4\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ArmUrl\",\"type\":1,\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"\\\\\\\"{Subscription}/providers/Microsoft.Insights/vmInsightsOnboardingStatuses?api-version=2018-11-27-preview\\\\\\\"\\\",\\\"transformers\\\":null}\",\"isHiddenWhenLocked\":true,\"queryType\":8},{\"id\":\"3c565109-cd86-401f-8058-a22b7c4f84f8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"OnboardQueryResult\",\"type\":1,\"isRequired\":true,\"query\":\"{\\\"version\\\":\\\"ARMEndpoint/1.0\\\",\\\"data\\\":null,\\\"headers\\\":[],\\\"method\\\":\\\"GET\\\",\\\"path\\\":\\\"{ArmUrl}\\\",\\\"urlParams\\\":[],\\\"batchDisabled\\\":false,\\\"transformers\\\":null}\",\"isHiddenWhenLocked\":true,\"queryType\":12},{\"id\":\"3ea80cfd-261e-4866-a90d-535e7183e95e\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TargetWorkspaces\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"{OnboardQueryResult}\\\",\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"tablePath\\\":\\\"$.value.*\\\",\\\"columns\\\":[{\\\"path\\\":\\\"$.properties.data.*.workspace.id\\\",\\\"columnid\\\":\\\"Workspaces\\\"}]}}]}\",\"value\":[\"value::all\"],\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"queryType\":8},{\"id\":\"f3ae6f16-55ee-490c-91a3-587f065531da\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DistinctTargetWorkspaces\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"Resources\\r\\n| take 1\\r\\n| project ws = '{TargetWorkspaces}'\\r\\n| extend ws = replace(@'\\\"\\\\[', '', ws)\\r\\n| extend ws = replace(@'\\\\]\\\"', '', ws)\\r\\n| extend ws = todynamic(strcat('[', ws, ']'))\\r\\n| mvexpand ws limit 400\\r\\n| summarize by tolower(tostring(ws))\",\"crossComponentResources\":[\"{Subscription}\"],\"value\":[\"value::all\"],\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"7597de36-91ca-4ccf-aed8-2c90bd79f036\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspaces\",\"type\":5,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"Resources\\r\\n| where id in~ ({DistinctTargetWorkspaces}) \\r\\n| project value = id, label = id, selected = true\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"548f7806-2f00-4915-a8bb-a2eec5c2e577\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"value\":{\"durationMs\":1209600000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":86400000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 4\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"69499589-1e36-46ec-aea1-567b9287f085\",\"cellValue\":\"SelectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"VMs with Over Utilized CPU\",\"subTarget\":\"CPU\",\"style\":\"link\"},{\"id\":\"5548ea11-b0b6-4af8-bdb3-cc39f4c21188\",\"cellValue\":\"SelectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"VMs with Over Utilized Memory\",\"subTarget\":\"Memory\",\"style\":\"link\"},{\"id\":\"5e870ec1-84cd-461d-9025-21955b180406\",\"cellValue\":\"SelectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"VMs with Over Utilized Disks\",\"subTarget\":\"Disk\",\"style\":\"link\"}]},\"name\":\"Tabs\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let VM_info=VMComputer \\r\\n| where TimeGenerated > ago(30d)\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| summarize arg_max(TimeGenerated, *) by VM\\r\\n| extend ['Azure Size']=iff(AzureSize == \\\"\\\", \\\"N/A\\\", AzureSize)\\r\\n| project VM,['Azure Size'];\\r\\n//\\r\\nlet VM_physicalMemory=InsightsMetrics\\r\\n| where TimeGenerated > ago(30d)\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where Namespace == 'Memory' and Name == 'AvailableMB'\\r\\n| summarize arg_max(TimeGenerated, *) by VM\\r\\n| extend memorySizeMB=parse_json(Tags)[\\\"vm.azm.ms/memorySizeMB\\\"]\\r\\n| extend RAM_GiB = round(memorySizeMB/todouble(1024))\\r\\n| extend location=iff(_ResourceId contains \\\"/virtualmachines/\\\", \\\"Azure\\\", \\\"On-premise\\\")\\r\\n| project VM,RAM_GiB,location;\\r\\n//\\r\\nlet VM_physicalCPU=InsightsMetrics\\r\\n| where TimeGenerated > ago(30d)\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where (Namespace == 'Processor' and Name == 'UtilizationPercentage')\\r\\n| summarize arg_max(TimeGenerated, *) by VM\\r\\n| extend totalCpus=parse_json(Tags)[\\\"vm.azm.ms/totalCpus\\\"]\\r\\n| project VM,totalCpus;\\r\\n//\\r\\nInsightsMetrics\\r\\n| where TimeGenerated {TimeRange:value}\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where Namespace == 'Memory' and Name == 'AvailableMB'\\r\\n| extend memorySizeMB=parse_json(Tags)[\\\"vm.azm.ms/memorySizeMB\\\"]\\r\\n| extend memoryUtitilization=round(100-(Val/memorySizeMB)*100, 1)\\r\\n| extend ['RAM (GiB)'] = round(memorySizeMB/todouble(1024))\\r\\n| project TimeGenerated,VM, ['RAM (GiB)'], memoryUtitilization, memorySizeMB\\r\\n| summarize Hourly_P95th = percentile(memoryUtitilization, 95) by bin(TimeGenerated, 1h), VM\\r\\n| summarize AVG=round(avg(Hourly_P95th),1), P95th=percentile(Hourly_P95th, 95), MAX=max(Hourly_P95th)  by VM\\r\\n| where MAX > 80\\r\\n| join kind=leftouter VM_info on VM\\r\\n| join kind=leftouter VM_physicalCPU on VM\\r\\n| join kind=leftouter VM_physicalMemory on VM\\r\\n| project VM,location,\\r\\n    Size= strcat(totalCpus, \\\" vcpus, \\\", split(tostring(RAM_GiB),\\\".\\\")[0], \\\" GiB memory\\\"),\\r\\n    ['Azure Size'],\\r\\n    AVG,P95th,MAX\\r\\n| sort by P95th desc\\r\\n| where VM !=\\\"\\\"\",\"size\":1,\"showAnalytics\":true,\"title\":\"VMs with Memory Usage greater than 80% \",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"VM\",\"exportParameterName\":\"selectedVM\",\"exportDefaultValue\":\"All\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"AVG\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"P95th\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"MAX\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"sortBy\":[]},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Memory\"},\"showPin\":true,\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n| where TimeGenerated {TimeRange:value}\\r\\n| where Namespace == 'Memory' and Name == 'AvailableMB'\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where VM == \\\"{selectedVM}\\\"\\r\\n| extend memorySizeMB=parse_json(Tags)[\\\"vm.azm.ms/memorySizeMB\\\"]\\r\\n| extend memoryUtitilization=round(100-(Val/memorySizeMB)*100, 1)\\r\\n| extend ['RAM (GiB)'] = round(memorySizeMB/todouble(1024))\\r\\n| project TimeGenerated,VM, ['RAM (GiB)'], memoryUtitilization, memorySizeMB\\r\\n| summarize Hourly_P95th = percentile(memoryUtitilization, 95) by bin(TimeGenerated, 1h), VM\\r\\n| render timechart\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"Memory usage over the time (P95th)\",\"noDataMessage\":\"make selection\",\"noDataMessageStyle\":5,\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"MemoryTimeBrush\",\"timeBrushExportOnlyWhenBrushed\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"max_Hourly_P95th\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"max_Hourly_P95th\",\"sortOrder\":2}],\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Memory\"},\"showPin\":true,\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n//| where TimeGenerated {TimeRange:value}\\r\\n| where Namespace == 'Memory' and Name == 'AvailableMB'\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where VM == \\\"{selectedVM}\\\"\\r\\n| extend memorySizeMB=parse_json(Tags)[\\\"vm.azm.ms/memorySizeMB\\\"]\\r\\n| extend memoryUtitilization=round(100-(Val/memorySizeMB)*100, 1)\\r\\n| extend ['RAM (GiB)'] = round(memorySizeMB/todouble(1024))\\r\\n| project TimeGenerated,VM, ['RAM (GiB)'], memoryUtitilization, memorySizeMB\\r\\n| summarize Hourly_P95th = percentile(memoryUtitilization, 95) by bin(TimeGenerated, 15m), VM\\r\\n| render timechart\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"Click and drag on Memory Chart to select specific TimeRange\",\"noDataMessage\":\"Click and drag on Memory Chart to select specific TimeRange\",\"timeContextFromParameter\":\"MemoryTimeBrush\",\"timeBrushParameterName\":\"Checkbrush1\",\"timeBrushExportOnlyWhenBrushed\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Memory\"},\"showPin\":true,\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n| where TimeGenerated {TimeRange:value}\\r\\n| where (Namespace == 'Processor' and Name == 'UtilizationPercentage')\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where VM == \\\"{selectedVM}\\\"\\r\\n| summarize Hourly_P95th = round(percentile(Val, 95), 1) by bin(TimeGenerated, 1h), VM\\r\\n| render timechart\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"CPU usage over the time (P95th)\",\"noDataMessage\":\"make selection\",\"noDataMessageStyle\":5,\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"CPUTimeBrush\",\"timeBrushExportOnlyWhenBrushed\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Memory\"},\"showPin\":true,\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n//| where TimeGenerated {TimeRange:value}\\r\\n| where (Namespace == 'Processor' and Name == 'UtilizationPercentage')\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where VM == \\\"{selectedVM}\\\"\\r\\n| summarize Hourly_P95th = round(percentile(Val, 95), 1) by bin(TimeGenerated, 15m), VM\\r\\n| render timechart\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"Click and drag on CPU Chart to select specific TimeRange\",\"timeContextFromParameter\":\"CPUTimeBrush\",\"timeBrushParameterName\":\"Checkbrush2\",\"timeBrushExportOnlyWhenBrushed\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Memory\"},\"showPin\":true,\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let VM_info=VMComputer \\r\\n| where TimeGenerated > ago(30d)\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| summarize arg_max(TimeGenerated, *) by VM\\r\\n| extend ['Azure Size']=iff(AzureSize == \\\"\\\", \\\"N/A\\\", AzureSize)\\r\\n| project VM,['Azure Size'];\\r\\n//\\r\\nlet VM_physicalMemory=InsightsMetrics\\r\\n| where TimeGenerated > ago(30d)\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where Namespace == 'Memory' and Name == 'AvailableMB'\\r\\n| summarize arg_max(TimeGenerated, *) by VM\\r\\n| extend memorySizeMB=parse_json(Tags)[\\\"vm.azm.ms/memorySizeMB\\\"]\\r\\n| extend RAM_GiB = round(memorySizeMB/todouble(1024))\\r\\n| extend location=iff(_ResourceId contains \\\"/virtualmachines/\\\", \\\"Azure\\\", \\\"On-premise\\\")\\r\\n| project VM,RAM_GiB,location;\\r\\n//\\r\\nlet VM_physicalCPU=InsightsMetrics\\r\\n| where TimeGenerated > ago(30d)\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where (Namespace == 'Processor' and Name == 'UtilizationPercentage')\\r\\n| summarize arg_max(TimeGenerated, *) by VM\\r\\n| extend totalCpus=parse_json(Tags)[\\\"vm.azm.ms/totalCpus\\\"]\\r\\n| project VM,totalCpus;\\r\\n//\\r\\nInsightsMetrics\\r\\n| where TimeGenerated {TimeRange:value}\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where (Namespace == 'Processor' and Name == 'UtilizationPercentage')\\r\\n| summarize Hourly_P95th = round(percentile(Val, 95), 1) by bin(TimeGenerated, 1h), VM\\r\\n| summarize AVG=round(avg(Hourly_P95th),1), P95th=percentile(Hourly_P95th, 95), MAX=max(Hourly_P95th)  by VM\\r\\n| where MAX > 80\\r\\n| join kind=leftouter VM_info on VM\\r\\n| join kind=leftouter VM_physicalCPU on VM\\r\\n| join kind=leftouter VM_physicalMemory on VM\\r\\n| project VM,location,\\r\\n    Size= strcat(totalCpus, \\\" vcpus, \\\", split(tostring(RAM_GiB),\\\".\\\")[0], \\\" GiB memory\\\"),\\r\\n    ['Azure Size'],\\r\\n    AVG,P95th,MAX\\r\\n| sort by P95th desc\\r\\n| where VM !=\\\"\\\"\",\"size\":1,\"showAnalytics\":true,\"title\":\"VMs with CPU Usage greater than 80% \",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"VM\",\"exportParameterName\":\"selectedVM1\",\"exportDefaultValue\":\"All\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"AVG\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"P95th\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"MAX\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"CPU\"},\"showPin\":true,\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n| where TimeGenerated {TimeRange:value}\\r\\n| where (Namespace == 'Processor' and Name == 'UtilizationPercentage')\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where VM == \\\"{selectedVM1}\\\"\\r\\n| summarize Hourly_P95th = round(percentile(Val, 95), 1) by bin(TimeGenerated, 1h), VM\\r\\n| render timechart\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"CPU usage over the time (P95th)\",\"noDataMessage\":\"make selection\",\"noDataMessageStyle\":5,\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"CPUTimeBrush1\",\"timeBrushExportOnlyWhenBrushed\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"CPU\"},\"showPin\":true,\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n//| where TimeGenerated {TimeRange:value}\\r\\n| where (Namespace == 'Processor' and Name == 'UtilizationPercentage')\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where VM == \\\"{selectedVM1}\\\"\\r\\n| summarize Hourly_P95th = round(percentile(Val, 95), 1) by bin(TimeGenerated, 15m), VM\\r\\n| render timechart\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"Click and drag on CPU Chart to select specific TimeRange\",\"noDataMessage\":\"Click and drag on CPU Chart to select specific TimeRange\",\"timeContextFromParameter\":\"CPUTimeBrush1\",\"timeBrushParameterName\":\"Checkbrush3\",\"timeBrushExportOnlyWhenBrushed\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"CPU\"},\"showPin\":true,\"name\":\"query - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n| where TimeGenerated {TimeRange:value}\\r\\n| where Namespace == 'Memory' and Name == 'AvailableMB'\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where VM == \\\"{selectedVM1}\\\"\\r\\n| extend memorySizeMB=parse_json(Tags)[\\\"vm.azm.ms/memorySizeMB\\\"]\\r\\n| extend memoryUtitilization=round(100-(Val/memorySizeMB)*100, 1)\\r\\n| extend ['RAM (GiB)'] = round(memorySizeMB/todouble(1024))\\r\\n| project TimeGenerated,VM, ['RAM (GiB)'], memoryUtitilization, memorySizeMB\\r\\n| summarize Hourly_P95th = percentile(memoryUtitilization, 95) by bin(TimeGenerated, 1h), VM\\r\\n| render timechart\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"Memory usage over the time (P95th)\",\"noDataMessage\":\"make selection\",\"noDataMessageStyle\":5,\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"MemoryTimeBrush1\",\"timeBrushExportOnlyWhenBrushed\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"CPU\"},\"showPin\":true,\"name\":\"query - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n//| where TimeGenerated {TimeRange:value}\\r\\n| where Namespace == 'Memory' and Name == 'AvailableMB'\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where VM == \\\"{selectedVM1}\\\"\\r\\n| extend memorySizeMB=parse_json(Tags)[\\\"vm.azm.ms/memorySizeMB\\\"]\\r\\n| extend memoryUtitilization=round(100-(Val/memorySizeMB)*100, 1)\\r\\n| extend ['RAM (GiB)'] = round(memorySizeMB/todouble(1024))\\r\\n| project TimeGenerated,VM, ['RAM (GiB)'], memoryUtitilization, memorySizeMB\\r\\n| summarize Hourly_P95th = percentile(memoryUtitilization, 95) by bin(TimeGenerated, 15m), VM\\r\\n| render timechart\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"Click and drag on Memory Chart to select specific TimeRange\",\"noDataMessage\":\"Click and drag on Memory Chart to select specific TimeRange\",\"timeContextFromParameter\":\"MemoryTimeBrush1\",\"timeBrushParameterName\":\"Checkbrush4\",\"timeBrushExportOnlyWhenBrushed\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"CPU\"},\"showPin\":true,\"name\":\"query - 13\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let disk_info=InsightsMetrics\\r\\n    | extend VM= tostring(split(_ResourceId,\\\"machines/\\\")[1])\\r\\n    | where Namespace == 'LogicalDisk' and Name == 'FreeSpaceMB'\\r\\n    | extend Disk=parse_json(Tags)[\\\"vm.azm.ms/mountId\\\"]\\r\\n    | extend Disk_SizeMB=parse_json(Tags)[\\\"vm.azm.ms/diskSizeMB\\\"]\\r\\n    | extend FreeSpaceGB=round(Val / todouble(1024), 1)\\r\\n    | extend UsedSpaceGB=round((Disk_SizeMB-Val)/todouble(1024), 1)\\r\\n    | extend Disk_SizeGB=round(Disk_SizeMB/todouble(1024), 1)\\r\\n    | extend VM_Disk= strcat(VM,\\\" | \\\",Disk)\\r\\n    | summarize arg_max(TimeGenerated, *) by VM_Disk\\r\\n    | project VM_Disk,Disk_SizeGB,UsedSpaceGB,FreeSpaceGB;\\r\\n//\\r\\nInsightsMetrics\\r\\n    | extend VM= tostring(split(_ResourceId,\\\"machines/\\\")[1])\\r\\n    | where Namespace == 'LogicalDisk' and Name == 'FreeSpacePercentage'\\r\\n    | extend Disk=parse_json(Tags)[\\\"vm.azm.ms/mountId\\\"]\\r\\n    | extend Usage = round(100 - Val,1)\\r\\n    | extend VM_Disk= strcat(VM,\\\" | \\\",Disk)\\r\\n    | summarize arg_max(TimeGenerated, *) by VM_Disk\\r\\n    | extend location=iff(_ResourceId contains \\\"/virtualmachines/\\\", \\\"Azure\\\", \\\"On-premise\\\")\\r\\n    | join kind=leftouter disk_info on VM_Disk\\r\\n    | where Usage > 80\\r\\n    | sort by Usage desc \\r\\n    | project location, VM, [\\\"Disk Name\\\"]=Disk, [\\\"Disk Size (GiB)\\\"]=Disk_SizeGB, [\\\"Used Space (GiB)\\\"]=UsedSpaceGB, [\\\"Free Space (GiB)\\\"]= FreeSpaceGB, [\\\"Usage Percentage\\\"]=Usage\\r\\n\",\"size\":1,\"title\":\"VMs with Disk Usage greater than 80% \",\"timeContextFromParameter\":\"TimeRange\",\"exportedParameters\":[{\"fieldName\":\"VM\",\"parameterName\":\"SelectedVM3\",\"parameterType\":1,\"defaultValue\":\"All\"},{\"fieldName\":\"Disk Name\",\"parameterName\":\"Disk_Name\",\"parameterType\":1,\"defaultValue\":\"All\"}],\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Disk Size (GiB)\",\"formatter\":0,\"numberFormat\":{\"unit\":5,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Used Space (GiB)\",\"formatter\":0,\"numberFormat\":{\"unit\":5,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Free Space\",\"formatter\":0,\"numberFormat\":{\"unit\":5,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Usage Percentage\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"greenRed\",\"customColumnWidthSetting\":\"23ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"sortBy\":[]},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Disk\"},\"showPin\":true,\"name\":\"query - 14\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n    | extend VM= tostring(split(_ResourceId,\\\"machines/\\\")[1])\\r\\n    | where Namespace == 'LogicalDisk' and Name == 'FreeSpacePercentage'\\r\\n    | extend Disk=parse_json(Tags)[\\\"vm.azm.ms/mountId\\\"]\\r\\n    | extend Usage = round(100 - Val,1)\\r\\n    | extend VM_Disk= strcat(VM,\\\" | \\\",Disk)\\r\\n    | where VM_Disk == strcat(\\\"{SelectedVM3}\\\",\\\" | \\\",\\\"{Disk_Name}\\\")\\r\\n    | summarize Hourly_P95th = percentile(Usage, 95) by bin(TimeGenerated, 1h), VM_Disk\\r\\n    | render timechart\\r\\n\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"Disk usage over the time (P95th)\",\"noDataMessage\":\"make selection\",\"noDataMessageStyle\":5,\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"Checkbrush5\",\"timeBrushExportOnlyWhenBrushed\":true,\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Disk\"},\"showPin\":true,\"name\":\"query - 15\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"Azure Monitor\"]}",
          "version": "1.0",
          "sourceId": "Azure Monitor",
          "category": "workbook"
        }
      },
      {
        "name": "[guid(parameters('Workbook 2'))]",
        "type": "microsoft.insights/workbooks",
        "location": "[resourceGroup().location]",
        "apiVersion": "2022-04-01",
        "dependsOn": [],
        "kind": "shared",
        "properties": {
          "displayName": "[parameters('Workbook 2')]",
          "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Under  Utilized VMs\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"value::all\"],\"parameters\":[{\"id\":\"96d624a1-a062-42af-a2f1-cb99e39ee61f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"value\":null,\"typeSettings\":{\"additionalResourceOptions\":[],\"includeAll\":true}},{\"id\":\"eed277a7-4cd8-4699-9aa8-72189163c7b4\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ArmUrl\",\"type\":1,\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"\\\\\\\"{Subscription}/providers/Microsoft.Insights/vmInsightsOnboardingStatuses?api-version=2018-11-27-preview\\\\\\\"\\\",\\\"transformers\\\":null}\",\"isHiddenWhenLocked\":true,\"queryType\":8},{\"id\":\"3c565109-cd86-401f-8058-a22b7c4f84f8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"OnboardQueryResult\",\"type\":1,\"isRequired\":true,\"query\":\"{\\\"version\\\":\\\"ARMEndpoint/1.0\\\",\\\"data\\\":null,\\\"headers\\\":[],\\\"method\\\":\\\"GET\\\",\\\"path\\\":\\\"{ArmUrl}\\\",\\\"urlParams\\\":[],\\\"batchDisabled\\\":false,\\\"transformers\\\":null}\",\"isHiddenWhenLocked\":true,\"queryType\":12},{\"id\":\"3ea80cfd-261e-4866-a90d-535e7183e95e\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TargetWorkspaces\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"{OnboardQueryResult}\\\",\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"tablePath\\\":\\\"$.value.*\\\",\\\"columns\\\":[{\\\"path\\\":\\\"$.properties.data.*.workspace.id\\\",\\\"columnid\\\":\\\"Workspaces\\\"}]}}]}\",\"value\":[\"value::all\"],\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"queryType\":8},{\"id\":\"f3ae6f16-55ee-490c-91a3-587f065531da\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DistinctTargetWorkspaces\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"Resources\\r\\n| take 1\\r\\n| project ws = '{TargetWorkspaces}'\\r\\n| extend ws = replace(@'\\\"\\\\[', '', ws)\\r\\n| extend ws = replace(@'\\\\]\\\"', '', ws)\\r\\n| extend ws = todynamic(strcat('[', ws, ']'))\\r\\n| mvexpand ws limit 400\\r\\n| summarize by tolower(tostring(ws))\",\"crossComponentResources\":[\"{Subscription}\"],\"value\":[\"value::all\"],\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"7597de36-91ca-4ccf-aed8-2c90bd79f036\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspaces\",\"type\":5,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"Resources\\r\\n| where id in~ ({DistinctTargetWorkspaces}) \\r\\n| project value = id, label = id, selected = true\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"548f7806-2f00-4915-a8bb-a2eec5c2e577\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"value\":{\"durationMs\":1209600000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":86400000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 4\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"69499589-1e36-46ec-aea1-567b9287f085\",\"cellValue\":\"SelectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"VMs with Under Utilized CPU\",\"subTarget\":\"CPU\",\"style\":\"link\"},{\"id\":\"5548ea11-b0b6-4af8-bdb3-cc39f4c21188\",\"cellValue\":\"SelectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"VMs with Under Utilized Memory\",\"subTarget\":\"Memory\",\"style\":\"link\"},{\"id\":\"5e870ec1-84cd-461d-9025-21955b180406\",\"cellValue\":\"SelectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"VMs with Under Utilized Disks\",\"subTarget\":\"Disk\",\"style\":\"link\"}]},\"name\":\"Tabs\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let VM_info=VMComputer \\r\\n| where TimeGenerated > ago(30d)\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| summarize arg_max(TimeGenerated, *) by VM\\r\\n| extend ['Azure Size']=iff(AzureSize == \\\"\\\", \\\"N/A\\\", AzureSize)\\r\\n| project VM,['Azure Size'];\\r\\n//\\r\\nlet VM_physicalMemory=InsightsMetrics\\r\\n| where TimeGenerated > ago(30d)\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where Namespace == 'Memory' and Name == 'AvailableMB'\\r\\n| summarize arg_max(TimeGenerated, *) by VM\\r\\n| extend memorySizeMB=parse_json(Tags)[\\\"vm.azm.ms/memorySizeMB\\\"]\\r\\n| extend RAM_GiB = round(memorySizeMB/todouble(1024))\\r\\n| extend location=iff(_ResourceId contains \\\"/virtualmachines/\\\", \\\"Azure\\\", \\\"On-premise\\\")\\r\\n| project VM, location, RAM_GiB;\\r\\n//\\r\\nlet VM_physicalCPU=InsightsMetrics\\r\\n| where TimeGenerated > ago(30d)\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where (Namespace == 'Processor' and Name == 'UtilizationPercentage')\\r\\n| summarize arg_max(TimeGenerated, *) by VM\\r\\n| extend totalCpus=parse_json(Tags)[\\\"vm.azm.ms/totalCpus\\\"]\\r\\n| project VM,totalCpus;\\r\\n//\\r\\nInsightsMetrics\\r\\n| where TimeGenerated {TimeRange:value}\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where Namespace == 'Memory' and Name == 'AvailableMB'\\r\\n| extend memorySizeMB=parse_json(Tags)[\\\"vm.azm.ms/memorySizeMB\\\"]\\r\\n| extend memoryUtitilization=round(100-(Val/memorySizeMB)*100, 1)\\r\\n| extend ['RAM (GiB)'] = round(memorySizeMB/todouble(1024))\\r\\n| project TimeGenerated,VM, ['RAM (GiB)'], memoryUtitilization, memorySizeMB\\r\\n| summarize Hourly_P95th = percentile(memoryUtitilization, 95) by bin(TimeGenerated, 1h), VM\\r\\n| summarize AVG=round(avg(Hourly_P95th),1), P95th=percentile(Hourly_P95th, 95), MAX=max(Hourly_P95th)  by VM\\r\\n| where P95th < 35\\r\\n| join kind=leftouter VM_info on VM\\r\\n| join kind=leftouter VM_physicalCPU on VM\\r\\n| join kind=leftouter VM_physicalMemory on VM\\r\\n| project VM,location,\\r\\n    Size= strcat(totalCpus, \\\" vcpus, \\\", split(tostring(RAM_GiB),\\\".\\\")[0], \\\" GiB memory\\\"),\\r\\n    ['Azure Size'],\\r\\n    AVG,P95th,MAX\\r\\n| sort by P95th asc\\r\\n| where VM !=\\\"\\\"\",\"size\":1,\"showAnalytics\":true,\"title\":\"VMs with Memory Usage less than 35% \",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"VM\",\"exportParameterName\":\"selectedVM\",\"exportDefaultValue\":\"All\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"AVG\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"P95th\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"MAX\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"sortBy\":[]},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Memory\"},\"showPin\":true,\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n| where TimeGenerated {TimeRange:value}\\r\\n| where Namespace == 'Memory' and Name == 'AvailableMB'\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where VM == \\\"{selectedVM}\\\"\\r\\n| extend memorySizeMB=parse_json(Tags)[\\\"vm.azm.ms/memorySizeMB\\\"]\\r\\n| extend memoryUtitilization=round(100-(Val/memorySizeMB)*100, 1)\\r\\n| extend ['RAM (GiB)'] = round(memorySizeMB/todouble(1024))\\r\\n| project TimeGenerated,VM, ['RAM (GiB)'], memoryUtitilization, memorySizeMB\\r\\n| summarize Hourly_P95th = percentile(memoryUtitilization, 95) by bin(TimeGenerated, 1h), VM\\r\\n| render timechart\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"Memory usage over the time (P95th)\",\"noDataMessage\":\"make selection\",\"noDataMessageStyle\":5,\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"MemoryTimeBrush\",\"timeBrushExportOnlyWhenBrushed\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"max_Hourly_P95th\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"max_Hourly_P95th\",\"sortOrder\":2}],\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Memory\"},\"showPin\":true,\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n//| where TimeGenerated {TimeRange:value}\\r\\n| where Namespace == 'Memory' and Name == 'AvailableMB'\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where VM == \\\"{selectedVM}\\\"\\r\\n| extend memorySizeMB=parse_json(Tags)[\\\"vm.azm.ms/memorySizeMB\\\"]\\r\\n| extend memoryUtitilization=round(100-(Val/memorySizeMB)*100, 1)\\r\\n| extend ['RAM (GiB)'] = round(memorySizeMB/todouble(1024))\\r\\n| project TimeGenerated,VM, ['RAM (GiB)'], memoryUtitilization, memorySizeMB\\r\\n| summarize Hourly_P95th = percentile(memoryUtitilization, 95) by bin(TimeGenerated, 15m), VM\\r\\n| render timechart\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"Click and drag on Memory Chart to select specific TimeRange\",\"noDataMessage\":\"Click and drag on Memory Chart to select specific TimeRange\",\"timeContextFromParameter\":\"MemoryTimeBrush\",\"timeBrushParameterName\":\"ToCheck\",\"timeBrushExportOnlyWhenBrushed\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Memory\"},\"showPin\":true,\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n| where TimeGenerated {TimeRange:value}\\r\\n| where (Namespace == 'Processor' and Name == 'UtilizationPercentage')\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where VM == \\\"{selectedVM}\\\"\\r\\n| summarize Hourly_P95th = round(percentile(Val, 95), 1) by bin(TimeGenerated, 1h), VM\\r\\n| render timechart\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"CPU usage over the time (P95th)\",\"noDataMessage\":\"make selection\",\"noDataMessageStyle\":5,\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"CPUTimeBrush\",\"timeBrushExportOnlyWhenBrushed\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Memory\"},\"showPin\":true,\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n//| where TimeGenerated {TimeRange:value}\\r\\n| where (Namespace == 'Processor' and Name == 'UtilizationPercentage')\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where VM == \\\"{selectedVM}\\\"\\r\\n| summarize Hourly_P95th = round(percentile(Val, 95), 1) by bin(TimeGenerated, 15m), VM\\r\\n| render timechart\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"Click and drag on CPU Chart to select specific TimeRange\",\"timeContextFromParameter\":\"CPUTimeBrush\",\"timeBrushParameterName\":\"ToCheck\",\"timeBrushExportOnlyWhenBrushed\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Memory\"},\"showPin\":true,\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let VM_info=VMComputer \\r\\n| where TimeGenerated > ago(30d)\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| summarize arg_max(TimeGenerated, *) by VM\\r\\n| extend ['Azure Size']=iff(AzureSize == \\\"\\\", \\\"N/A\\\", AzureSize)\\r\\n| project VM,['Azure Size'];\\r\\n//\\r\\nlet VM_physicalMemory=InsightsMetrics\\r\\n| where TimeGenerated > ago(30d)\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where Namespace == 'Memory' and Name == 'AvailableMB'\\r\\n| summarize arg_max(TimeGenerated, *) by VM\\r\\n| extend memorySizeMB=parse_json(Tags)[\\\"vm.azm.ms/memorySizeMB\\\"]\\r\\n| extend RAM_GiB = round(memorySizeMB/todouble(1024))\\r\\n| extend location=iff(_ResourceId contains \\\"/virtualmachines/\\\", \\\"Azure\\\", \\\"On-premise\\\")\\r\\n| project VM, location, RAM_GiB;\\r\\n//\\r\\nlet VM_physicalCPU=InsightsMetrics\\r\\n| where TimeGenerated > ago(30d)\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where (Namespace == 'Processor' and Name == 'UtilizationPercentage')\\r\\n| summarize arg_max(TimeGenerated, *) by VM\\r\\n| extend totalCpus=parse_json(Tags)[\\\"vm.azm.ms/totalCpus\\\"]\\r\\n| project VM,totalCpus;\\r\\n//\\r\\nInsightsMetrics\\r\\n| where TimeGenerated {TimeRange:value}\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where (Namespace == 'Processor' and Name == 'UtilizationPercentage')\\r\\n| summarize Hourly_P95th = round(percentile(Val, 95), 1) by bin(TimeGenerated, 1h), VM\\r\\n| summarize AVG=round(avg(Hourly_P95th),1), P95th=percentile(Hourly_P95th, 95), MAX=max(Hourly_P95th)  by VM\\r\\n| where P95th < 35\\r\\n| join kind=leftouter VM_info on VM\\r\\n| join kind=leftouter VM_physicalCPU on VM\\r\\n| join kind=leftouter VM_physicalMemory on VM\\r\\n| project VM,location,\\r\\n    Size= strcat(totalCpus, \\\" vcpus, \\\", split(tostring(RAM_GiB),\\\".\\\")[0], \\\" GiB memory\\\"),\\r\\n    ['Azure Size'],\\r\\n    AVG,P95th,MAX\\r\\n| sort by P95th asc\\r\\n| where VM !=\\\"\\\"\",\"size\":1,\"showAnalytics\":true,\"title\":\"VMs with CPU Usage Less than 35% \",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"VM\",\"exportParameterName\":\"selectedVM1\",\"exportDefaultValue\":\"All\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"AVG\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"P95th\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"MAX\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"CPU\"},\"showPin\":true,\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n| where TimeGenerated {TimeRange:value}\\r\\n| where (Namespace == 'Processor' and Name == 'UtilizationPercentage')\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where VM == \\\"{selectedVM1}\\\"\\r\\n| summarize Hourly_P95th = round(percentile(Val, 95), 1) by bin(TimeGenerated, 1h), VM\\r\\n| render timechart\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"CPU usage over the time (P95th)\",\"noDataMessage\":\"make selection\",\"noDataMessageStyle\":5,\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"CPUTimeBrush1\",\"timeBrushExportOnlyWhenBrushed\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"CPU\"},\"showPin\":true,\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n//| where TimeGenerated {TimeRange:value}\\r\\n| where (Namespace == 'Processor' and Name == 'UtilizationPercentage')\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where VM == \\\"{selectedVM1}\\\"\\r\\n| summarize Hourly_P95th = round(percentile(Val, 95), 1) by bin(TimeGenerated, 15m), VM\\r\\n| render timechart\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"Click and drag on CPU Chart to select specific TimeRange\",\"noDataMessage\":\"Click and drag on CPU Chart to select specific TimeRange\",\"timeContextFromParameter\":\"CPUTimeBrush1\",\"timeBrushParameterName\":\"ToCheck\",\"timeBrushExportOnlyWhenBrushed\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"CPU\"},\"showPin\":true,\"name\":\"query - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n| where TimeGenerated {TimeRange:value}\\r\\n| where Namespace == 'Memory' and Name == 'AvailableMB'\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where VM == \\\"{selectedVM1}\\\"\\r\\n| extend memorySizeMB=parse_json(Tags)[\\\"vm.azm.ms/memorySizeMB\\\"]\\r\\n| extend memoryUtitilization=round(100-(Val/memorySizeMB)*100, 1)\\r\\n| extend ['RAM (GiB)'] = round(memorySizeMB/todouble(1024))\\r\\n| project TimeGenerated,VM, ['RAM (GiB)'], memoryUtitilization, memorySizeMB\\r\\n| summarize Hourly_P95th = percentile(memoryUtitilization, 95) by bin(TimeGenerated, 1h), VM\\r\\n| render timechart\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"Memory usage over the time (P95th)\",\"noDataMessage\":\"make selection\",\"noDataMessageStyle\":5,\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"MemoryTimeBrush1\",\"timeBrushExportOnlyWhenBrushed\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"CPU\"},\"showPin\":true,\"name\":\"query - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n//| where TimeGenerated {TimeRange:value}\\r\\n| where Namespace == 'Memory' and Name == 'AvailableMB'\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where VM == \\\"{selectedVM1}\\\"\\r\\n| extend memorySizeMB=parse_json(Tags)[\\\"vm.azm.ms/memorySizeMB\\\"]\\r\\n| extend memoryUtitilization=round(100-(Val/memorySizeMB)*100, 1)\\r\\n| extend ['RAM (GiB)'] = round(memorySizeMB/todouble(1024))\\r\\n| project TimeGenerated,VM, ['RAM (GiB)'], memoryUtitilization, memorySizeMB\\r\\n| summarize Hourly_P95th = percentile(memoryUtitilization, 95) by bin(TimeGenerated, 15m), VM\\r\\n| render timechart\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"Click and drag on Memory Chart to select specific TimeRange\",\"noDataMessage\":\"Click and drag on Memory Chart to select specific TimeRange\",\"timeContextFromParameter\":\"MemoryTimeBrush1\",\"timeBrushParameterName\":\"ToCheck\",\"timeBrushExportOnlyWhenBrushed\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"CPU\"},\"showPin\":true,\"name\":\"query - 13\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let disk_info=InsightsMetrics\\r\\n    | extend VM= tostring(split(_ResourceId,\\\"machines/\\\")[1])\\r\\n    | where Namespace == 'LogicalDisk' and Name == 'FreeSpaceMB'\\r\\n    | extend Disk=parse_json(Tags)[\\\"vm.azm.ms/mountId\\\"]\\r\\n    | extend Disk_SizeMB=parse_json(Tags)[\\\"vm.azm.ms/diskSizeMB\\\"]\\r\\n    | extend FreeSpaceGB=round(Val / todouble(1024), 1)\\r\\n    | extend UsedSpaceGB=round((Disk_SizeMB-Val)/todouble(1024), 1)\\r\\n    | extend Disk_SizeGB=round(Disk_SizeMB/todouble(1024), 1)\\r\\n    | extend VM_Disk= strcat(VM,\\\" | \\\",Disk)\\r\\n    | summarize arg_max(TimeGenerated, *) by VM_Disk\\r\\n    | project VM_Disk,Disk_SizeGB,UsedSpaceGB,FreeSpaceGB;\\r\\n//\\r\\nInsightsMetrics\\r\\n    | extend VM= tostring(split(_ResourceId,\\\"machines/\\\")[1])\\r\\n    | where Namespace == 'LogicalDisk' and Name == 'FreeSpacePercentage'\\r\\n    | extend Disk=parse_json(Tags)[\\\"vm.azm.ms/mountId\\\"]\\r\\n    | extend Usage = round(100 - Val,1)\\r\\n    | extend VM_Disk= strcat(VM,\\\" | \\\",Disk)\\r\\n    | summarize arg_max(TimeGenerated, *) by VM_Disk\\r\\n    | extend location=iff(_ResourceId contains \\\"/virtualmachines/\\\", \\\"Azure\\\", \\\"On-premise\\\")\\r\\n    | join kind=leftouter disk_info on VM_Disk\\r\\n    | where Usage < 10\\r\\n    | sort by Usage asc \\r\\n    | project location, VM, [\\\"Disk Name\\\"]=Disk, [\\\"Disk Size\\\"]=Disk_SizeGB, [\\\"Used Space\\\"]=UsedSpaceGB,[\\\"Free Space\\\"]= FreeSpaceGB, [\\\"Usage Percentage\\\"]=Usage\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"VMs with Disk Usage less than 10% \",\"timeContextFromParameter\":\"TimeRange\",\"exportedParameters\":[{\"fieldName\":\"VM\",\"parameterName\":\"SelectedVM3\",\"parameterType\":1,\"defaultValue\":\"All\"},{\"fieldName\":\"Disk Name\",\"parameterName\":\"Disk_Name\",\"parameterType\":1,\"defaultValue\":\"All\"}],\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Disk Size\",\"formatter\":0,\"numberFormat\":{\"unit\":5,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Used Space\",\"formatter\":0,\"numberFormat\":{\"unit\":5,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Free Space\",\"formatter\":0,\"numberFormat\":{\"unit\":5,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Usage Percentage\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"greenRed\",\"customColumnWidthSetting\":\"23ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"sortBy\":[]},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Disk\"},\"showPin\":true,\"name\":\"query - 14\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n    | extend VM= tostring(split(_ResourceId,\\\"machines/\\\")[1])\\r\\n    | where Namespace == 'LogicalDisk' and Name == 'FreeSpacePercentage'\\r\\n    | extend Disk=parse_json(Tags)[\\\"vm.azm.ms/mountId\\\"]\\r\\n    | extend Usage = round(100 - Val,1)\\r\\n    | extend VM_Disk= strcat(VM,\\\" | \\\",Disk)\\r\\n    | where VM_Disk == strcat(\\\"{SelectedVM3}\\\",\\\" | \\\",\\\"{Disk_Name}\\\")\\r\\n    | summarize Hourly_P95th = percentile(Usage, 95) by bin(TimeGenerated, 1h), VM_Disk\\r\\n    | render timechart\\r\\n\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"Disk usage over the time (P95th)\",\"noDataMessage\":\"make selection\",\"noDataMessageStyle\":5,\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"ToCheck\",\"timeBrushExportOnlyWhenBrushed\":true,\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Disk\"},\"showPin\":true,\"name\":\"query - 15\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"Azure Monitor\"]}",
          "version": "1.0",
          "sourceId": "Azure Monitor",
          "category": "workbook"
        }
      },
      {
        "name": "[guid(parameters('Workbook 3'))]",
        "type": "microsoft.insights/workbooks",
        "location": "[resourceGroup().location]",
        "apiVersion": "2022-04-01",
        "dependsOn": [],
        "kind": "shared",
        "properties": {
          "displayName": "[parameters('Workbook 3')]",
          "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# VM utilization over the time\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"value::all\"],\"parameters\":[{\"id\":\"96d624a1-a062-42af-a2f1-cb99e39ee61f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"value\":null,\"typeSettings\":{\"additionalResourceOptions\":[],\"includeAll\":true}},{\"id\":\"eed277a7-4cd8-4699-9aa8-72189163c7b4\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ArmUrl\",\"type\":1,\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"\\\\\\\"{Subscription}/providers/Microsoft.Insights/vmInsightsOnboardingStatuses?api-version=2018-11-27-preview\\\\\\\"\\\",\\\"transformers\\\":null}\",\"isHiddenWhenLocked\":true,\"queryType\":8},{\"id\":\"3c565109-cd86-401f-8058-a22b7c4f84f8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"OnboardQueryResult\",\"type\":1,\"isRequired\":true,\"query\":\"{\\\"version\\\":\\\"ARMEndpoint/1.0\\\",\\\"data\\\":null,\\\"headers\\\":[],\\\"method\\\":\\\"GET\\\",\\\"path\\\":\\\"{ArmUrl}\\\",\\\"urlParams\\\":[],\\\"batchDisabled\\\":false,\\\"transformers\\\":null}\",\"isHiddenWhenLocked\":true,\"queryType\":12},{\"id\":\"3ea80cfd-261e-4866-a90d-535e7183e95e\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TargetWorkspaces\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"{OnboardQueryResult}\\\",\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"tablePath\\\":\\\"$.value.*\\\",\\\"columns\\\":[{\\\"path\\\":\\\"$.properties.data.*.workspace.id\\\",\\\"columnid\\\":\\\"Workspaces\\\"}]}}]}\",\"value\":[\"value::all\"],\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"queryType\":8},{\"id\":\"f3ae6f16-55ee-490c-91a3-587f065531da\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DistinctTargetWorkspaces\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"Resources\\r\\n| take 1\\r\\n| project ws = '{TargetWorkspaces}'\\r\\n| extend ws = replace(@'\\\"\\\\[', '', ws)\\r\\n| extend ws = replace(@'\\\\]\\\"', '', ws)\\r\\n| extend ws = todynamic(strcat('[', ws, ']'))\\r\\n| mvexpand ws limit 400\\r\\n| summarize by tolower(tostring(ws))\",\"crossComponentResources\":[\"{Subscription}\"],\"value\":[\"value::all\"],\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"7597de36-91ca-4ccf-aed8-2c90bd79f036\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspaces\",\"type\":5,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"Resources\\r\\n| where id in~ ({DistinctTargetWorkspaces}) \\r\\n| project value = id, label = id, selected = true\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - 2\"},{\"type\":1,\"content\":{\"json\":\"_________________________________________________________________________________________________\\r\\n### Select Virtual Machine\"},\"name\":\"text - 4\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Workspaces}\"],\"parameters\":[{\"id\":\"154aae33-5447-450d-be98-0eee67a9872a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"value\":{\"durationMs\":604800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000},{\"durationMs\":5184000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\"},{\"id\":\"731f38c6-d3f0-43fb-9d26-ba93632d6e28\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Machine\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"InsightsMetrics \\r\\n| distinct _ResourceId \\r\\n| project VM= split(_ResourceId,\\\"machines/\\\")[1]\\r\\n| sort by tolower(VM) asc \\r\\n| where VM != \\\"\\\"\",\"crossComponentResources\":[\"{Workspaces}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\",\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":[]}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 3\"},{\"type\":1,\"content\":{\"json\":\"### VM Information\"},\"customWidth\":\"30\",\"name\":\"text - 13\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let VM_physicalMemory=InsightsMetrics\\r\\n| where TimeGenerated > ago(30d)\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where Namespace == 'Memory' and Name == 'AvailableMB'\\r\\n| summarize arg_max(TimeGenerated, *) by VM\\r\\n| extend memorySizeMB=parse_json(Tags)[\\\"vm.azm.ms/memorySizeMB\\\"]\\r\\n| extend RAM_GiB = round(memorySizeMB/todouble(1024))\\r\\n| extend location=iff(_ResourceId contains \\\"/virtualmachines/\\\", \\\"Azure\\\", \\\"On-premise\\\")\\r\\n| project VM, location, RAM_GiB;\\r\\n//\\r\\nVMComputer \\r\\n| extend VM= tostring(split(_ResourceId,\\\"machines/\\\")[1])\\r\\n| where VM in ({Machine})\\r\\n| summarize arg_max(TimeGenerated, *) by VM\\r\\n| join kind=leftouter VM_physicalMemory on VM\\r\\n| project VM,\\r\\n    location=iff(_ResourceId contains \\\"/virtualmachines/\\\", \\\"Azure\\\", \\\"On-premise\\\"),\\r\\n    ['Azure Size']=iff(AzureSize == \\\"\\\", \\\"N/A\\\", AzureSize),\\r\\n    vCPUs=Cpus,\\r\\n    ['RAM (GiB)']=toint(split(tostring(RAM_GiB),\\\".\\\")[0]),\\r\\n    OS=OperatingSystemFamily,\\r\\n    ['OS Type']=iff(OperatingSystemFullName contains \\\", \\\", tostring(split(OperatingSystemFullName,\\\", \\\")[1]), OperatingSystemFullName)\",\"size\":4,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"RAM (GiB)\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}}]}},\"name\":\"query - 9\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"3129db7d-24ca-455c-989c-9d5c56327891\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Aggregate\",\"type\":2,\"isRequired\":true,\"value\":\"P95th = round(percentile(Val, 95), 1)\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    { \\\"value\\\":\\\"Average = round(avg(Val), 1)\\\", \\\"label\\\":\\\"Average\\\"},\\r\\n    { \\\"value\\\":\\\"P95th = round(percentile(Val, 95), 1)\\\", \\\"label\\\":\\\"P95th\\\"},\\r\\n    { \\\"value\\\":\\\"Max = round(max(Val), 1)\\\", \\\"label\\\":\\\"Max\\\"}\\r\\n]\",\"timeContext\":{\"durationMs\":86400000}},{\"id\":\"70a1b7e5-8ce9-48a1-b371-1b62add56020\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"aggregateLeftValue\",\"type\":1,\"isRequired\":true,\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"\\\\\\\"{Aggregate:value}\\\\\\\"\\\",\\\"transformers\\\":null}\",\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":86400000},\"queryType\":8},{\"id\":\"537a4e6f-f748-4200-b528-d69d38bc91c0\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"aggregateLeftLabel\",\"type\":1,\"isRequired\":true,\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"\\\\\\\"{Aggregate:label}\\\\\\\"\\\",\\\"transformers\\\":null}\",\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":86400000},\"queryType\":8}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n| extend VM= tostring(split(_ResourceId,\\\"machines/\\\")[1])\\r\\n| where VM in ({Machine})\\r\\n| where (Namespace == 'Processor' and Name == 'UtilizationPercentage')\\r\\n| summarize {aggregateLeftValue} by bin(TimeGenerated, ({TimeRange:end} - {TimeRange:start})/400), VM\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"CPU Utilization %\",\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"justcheck\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"visualization\":\"timechart\",\"chartSettings\":{\"showLegend\":true,\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"showPin\":true,\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n| where Namespace == 'Memory' and Name == 'AvailableMB'\\r\\n| extend VM= tostring(split(_ResourceId, \\\"machines/\\\")[1])\\r\\n| where VM in ({Machine})\\r\\n| extend memorySizeMB=parse_json(Tags)[\\\"vm.azm.ms/memorySizeMB\\\"]\\r\\n| extend memoryUtitilization=round(100 - (Val / memorySizeMB) * 100, 1)\\r\\n| extend ['RAM (GiB)'] = round(memorySizeMB / todouble(1024))\\r\\n| project TimeGenerated, VM, ['RAM (GiB)'], memoryUtitilization, memorySizeMB\\r\\n| extend Val=memoryUtitilization\\r\\n| summarize {aggregateLeftValue} by bin(TimeGenerated, ({TimeRange:end} - {TimeRange:start})/400), VM\\r\\n| render timechart\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"Memory Utilization %\",\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"justcheck1\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"chartSettings\":{\"showLegend\":true,\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":1}},\"min\":0,\"max\":100}}},\"showPin\":true,\"name\":\"query - 7\"},{\"type\":1,\"content\":{\"json\":\"### Available Memory\"},\"customWidth\":\"20\",\"name\":\"text - 10\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Workspaces}\"],\"parameters\":[{\"id\":\"7ce8ddd5-9e15-450d-aad0-9d417f3cf39e\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Aggregate\",\"type\":2,\"isRequired\":true,\"value\":\"P5th = round(percentile(Val, 5), 1)\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    { \\\"value\\\":\\\"Average = round(avg(Val), 1)\\\", \\\"label\\\":\\\"Average\\\"},\\r\\n    { \\\"value\\\":\\\"P5th = round(percentile(Val, 5), 1)\\\", \\\"label\\\":\\\"P5th\\\"},\\r\\n    { \\\"value\\\":\\\"Min = round(min(Val), 1)\\\", \\\"label\\\":\\\"Min\\\"}\\r\\n]\",\"timeContext\":{\"durationMs\":86400000}},{\"id\":\"8960d77a-c2f8-4695-8d46-a5c78e9d2644\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"aggregateRightValue\",\"type\":1,\"isRequired\":true,\"query\":\"print \\\"{Aggregate:value}\\\"\",\"crossComponentResources\":[\"{Workspaces}\"],\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"28fae257-343d-491e-9b1a-13cfd452cd63\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"aggregateRightLabel\",\"type\":1,\"isRequired\":true,\"query\":\"print \\\"{Aggregate:label}\\\"\",\"crossComponentResources\":[\"{Workspaces}\"],\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"InsightsMetrics\\r\\n| extend VM= tostring(split(_ResourceId,\\\"machines/\\\")[1])\\r\\n| where VM in ({Machine})\\r\\n| where Namespace == 'Memory' and Name == 'AvailableMB'\\r\\n| summarize {aggregateRightValue} by bin(TimeGenerated, ({TimeRange:end} - {TimeRange:start})/400), VM\",\"size\":0,\"aggregation\":3,\"showAnnotations\":true,\"showAnalytics\":true,\"title\":\"Available Memory\",\"noDataMessage\":\"There is no data for this counter, either enable the counter or onboard machines to this workspace\",\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"justcheck3\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"showLegend\":true,\"ySettings\":{\"numberFormatSettings\":{\"unit\":4,\"options\":{\"style\":\"decimal\",\"useGrouping\":false}},\"min\":0}}},\"showPin\":true,\"name\":\"query - 12\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"Azure Monitor\"]}",
          "version": "1.0",
          "sourceId": "Azure Monitor",
          "category": "workbook"
        }
      },
      {
        "name": "[guid(parameters('Workbook 4'))]",
        "type": "microsoft.insights/workbooks",
        "location": "[resourceGroup().location]",
        "apiVersion": "2022-04-01",
        "dependsOn": [],
        "kind": "shared",
        "properties": {
          "displayName": "[parameters('Workbook 4')]",
          "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Disk Usage\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"value::all\"],\"parameters\":[{\"id\":\"96d624a1-a062-42af-a2f1-cb99e39ee61f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"value\":null,\"typeSettings\":{\"additionalResourceOptions\":[],\"includeAll\":true}},{\"id\":\"eed277a7-4cd8-4699-9aa8-72189163c7b4\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ArmUrl\",\"type\":1,\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"\\\\\\\"{Subscription}/providers/Microsoft.Insights/vmInsightsOnboardingStatuses?api-version=2018-11-27-preview\\\\\\\"\\\",\\\"transformers\\\":null}\",\"isHiddenWhenLocked\":true,\"queryType\":8},{\"id\":\"3c565109-cd86-401f-8058-a22b7c4f84f8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"OnboardQueryResult\",\"type\":1,\"isRequired\":true,\"query\":\"{\\\"version\\\":\\\"ARMEndpoint/1.0\\\",\\\"data\\\":null,\\\"headers\\\":[],\\\"method\\\":\\\"GET\\\",\\\"path\\\":\\\"{ArmUrl}\\\",\\\"urlParams\\\":[],\\\"batchDisabled\\\":false,\\\"transformers\\\":null}\",\"isHiddenWhenLocked\":true,\"queryType\":12},{\"id\":\"3ea80cfd-261e-4866-a90d-535e7183e95e\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TargetWorkspaces\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"{OnboardQueryResult}\\\",\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"tablePath\\\":\\\"$.value.*\\\",\\\"columns\\\":[{\\\"path\\\":\\\"$.properties.data.*.workspace.id\\\",\\\"columnid\\\":\\\"Workspaces\\\"}]}}]}\",\"value\":[\"value::all\"],\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"queryType\":8},{\"id\":\"f3ae6f16-55ee-490c-91a3-587f065531da\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DistinctTargetWorkspaces\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"Resources\\r\\n| take 1\\r\\n| project ws = '{TargetWorkspaces}'\\r\\n| extend ws = replace(@'\\\"\\\\[', '', ws)\\r\\n| extend ws = replace(@'\\\\]\\\"', '', ws)\\r\\n| extend ws = todynamic(strcat('[', ws, ']'))\\r\\n| mvexpand ws limit 400\\r\\n| summarize by tolower(tostring(ws))\",\"crossComponentResources\":[\"{Subscription}\"],\"value\":[\"value::all\"],\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"7597de36-91ca-4ccf-aed8-2c90bd79f036\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspaces\",\"type\":5,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"Resources\\r\\n| where id in~ ({DistinctTargetWorkspaces}) \\r\\n| project value = id, label = id, selected = true\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - 2\"},{\"type\":1,\"content\":{\"json\":\"_________________________________________________________________________________________________\\r\\n### Select Virtual Machine\"},\"name\":\"text - 4\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Workspaces}\"],\"parameters\":[{\"id\":\"154aae33-5447-450d-be98-0eee67a9872a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"value\":{\"durationMs\":604800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000},{\"durationMs\":5184000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\"},{\"id\":\"731f38c6-d3f0-43fb-9d26-ba93632d6e28\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Machine\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"InsightsMetrics \\r\\n| distinct _ResourceId \\r\\n| project VM= split(_ResourceId,\\\"machines/\\\")[1]\\r\\n| sort by tolower(VM) asc \\r\\n| where VM != \\\"\\\"\",\"crossComponentResources\":[\"{Workspaces}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\",\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":[\"value::all\"]}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let disk_info=InsightsMetrics\\r\\n    | extend VM= tostring(split(_ResourceId,\\\"machines/\\\")[1])\\r\\n    | where Namespace == 'LogicalDisk' and Name == 'FreeSpaceMB'\\r\\n    | extend Disk=parse_json(Tags)[\\\"vm.azm.ms/mountId\\\"]\\r\\n    | extend Disk_SizeMB=parse_json(Tags)[\\\"vm.azm.ms/diskSizeMB\\\"]\\r\\n    | extend FreeSpaceGB=round(Val / todouble(1024), 1)\\r\\n    | extend UsedSpaceGB=round((Disk_SizeMB-Val)/todouble(1024), 1)\\r\\n    | extend Disk_SizeGB=round(Disk_SizeMB/todouble(1024), 1)\\r\\n    | extend VM_Disk= strcat(VM,\\\" | \\\",Disk)\\r\\n    | summarize arg_max(TimeGenerated, *) by VM_Disk\\r\\n    | project VM_Disk,Disk_SizeGB,UsedSpaceGB,FreeSpaceGB;\\r\\n//\\r\\nInsightsMetrics\\r\\n    | extend VM= tostring(split(_ResourceId,\\\"machines/\\\")[1])\\r\\n    | where \\\"{Machine:label}\\\" == 'All' or VM in ({Machine})\\r\\n    | where Namespace == 'LogicalDisk' and Name == 'FreeSpacePercentage'\\r\\n    | extend Disk=parse_json(Tags)[\\\"vm.azm.ms/mountId\\\"]\\r\\n    | extend Usage = round(100 - Val,1)\\r\\n    | extend VM_Disk= strcat(VM,\\\" | \\\",Disk)\\r\\n    | summarize arg_max(TimeGenerated, *) by VM_Disk\\r\\n    | extend location=iff(_ResourceId contains \\\"/virtualmachines/\\\", \\\"Azure\\\", \\\"On-premise\\\")\\r\\n    | join kind=leftouter disk_info on VM_Disk\\r\\n    | sort by Usage desc \\r\\n    | project location, VM, [\\\"Disk Name\\\"]=Disk, [\\\"Disk Size (GiB)\\\"]=Disk_SizeGB, [\\\"Used Space (GiB)\\\"]=UsedSpaceGB, [\\\"Free Space (GiB)\\\"]= FreeSpaceGB, [\\\"Usage Percentage\\\"]=Usage\\r\\n\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Disk Size (GiB)\",\"formatter\":0,\"numberFormat\":{\"unit\":5,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Used Space (GiB)\",\"formatter\":0,\"numberFormat\":{\"unit\":5,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Free Space\",\"formatter\":0,\"numberFormat\":{\"unit\":5,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Usage\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"greenRed\",\"customColumnWidthSetting\":\"23ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}}],\"rowLimit\":10000,\"filter\":true}},\"showPin\":true,\"name\":\"query - 4\",\"styleSettings\":{\"showBorder\":true}}],\"isLocked\":false,\"fallbackResourceIds\":[\"Azure Monitor\"]}",
          "version": "1.0",
          "sourceId": "Azure Monitor",
          "category": "workbook"
        }
      }
    ]
  }